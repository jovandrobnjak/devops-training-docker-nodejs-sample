name: Create and publish a Docker image

on:
    workflow_dispatch:
        inputs:
            version:
                description: 'Verison for manual trigger'
                required: true
                type: string
    push:
        tags:
            - 'v[0-9]+.[0-9]+.[0-9]+'

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}
    IMAGE_TAG: ${{github.event_name == 'push' && github.ref_name || inputs.version}}
    AWS_REGION: eu-central-1
    AWS_ECR_REPOSITORY: jovand-private-ecr
    CLUSTER_NAME: jovand-cluster
    RELEASE_NAME: jovand-todo-app

jobs:
    test-app:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18.x'
            - run: npm install
            - run: npm test

    build-and-push-image:
        needs: test-app
        runs-on: ubuntu-latest
        permissions:
            id-token: write
            contents: read
            packages: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Log in to the Container registry
              uses: docker/login-action@65b78e6e13532edd9afa3aa52ac7964289d1a9c1
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
                  aws-region: ${{env.AWS_REGION}}

            - name: Login to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v2
              with:
                  registries: ${{ secrets.AWS_ACCOUNT_ID }}
                  mask-password: 'true'

            - name: Build and push Docker image
              uses: docker/build-push-action@f2a1d5e99d037542a71f64918e516c093c6f3fc4
              with:
                  context: .
                  push: true
                  tags: |
                      ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{env.IMAGE_TAG}}
                      ${{ steps.login-ecr.outputs.registry}}/${{ env.AWS_ECR_REPOSITORY }}:docker-${{env.IMAGE_TAG}}
            - name: Install helm and kubectl, login into registry and update kubeconfit, do eks deploy
              run:
                  curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
                  curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl.sha256"
                  echo "$(cat kubectl.sha256)  kubectl" | sha256sum --check

                  sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

                  kubectl version --client
                  curl https://baltocdn.com/helm/signing.asc | gpg --dearmor | sudo tee /usr/share/keyrings/helm.gpg > /dev/null
                  sudo apt-get install apt-transport-https --yes
                  echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/helm.gpg] https://baltocdn.com/helm/stable/debian/ all main" | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list
                  sudo apt-get update
                  sudo apt-get install helm
                  aws ecr get-login-password \
                  --region ${{ env.AWS_REGION }} | helm registry login \
                  --username AWS \
                  --password-stdin  ${{ steps.login-ecr.outputs.registry}}
                  aws eks update-kubeconfig --name ${{ env.CLUSTER_NAME }} --region ${{ env.AWS_REGION }}
                  helm upgrade --reuse-values --set "app.tag"="docker-${{ env.IMAGE_TAG }}" --namespace vegait-training ${{env.RELEASE_NAME}} oci://${{ steps.login-ecr.outputs.registry}}/${{ env.AWS_ECR_REPOSITORY }}
